\
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#04110b" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icons/icon-192.png" />
  <title>Calculator</title>
  <style>
    :root{
      --bg0:#050807;
      --bg1:#04110b;
      --card:rgba(12,28,20,.88);
      --card2:rgba(10,35,22,.92);
      --line:rgba(120,255,170,.12);
      --key:#0f1d16;
      --key2:#123325;
      --text:#e8f7ee;
      --muted:rgba(232,247,238,.68);
      --shadow:0 18px 60px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:
        radial-gradient(1200px 900px at 20% -10%, rgba(60,255,170,.10), transparent 60%),
        radial-gradient(900px 700px at 90% 25%, rgba(60,180,255,.07), transparent 55%),
        linear-gradient(180deg,var(--bg1),var(--bg0));
      color:var(--text);
      height:100vh;
      overflow:hidden;
    }
    .wrap{
      max-width:430px;
      height:100vh;
      margin:0 auto;
      padding:16px 14px 18px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .topbar{display:flex;justify-content:center;align-items:center;position:relative;padding-top:10px}
    .title{opacity:.9;font-size:16px;letter-spacing:.2px}
    .display{
      flex:0 0 28%;
      display:flex;
      justify-content:flex-end;
      align-items:flex-end;
      padding:0 8px 8px;
      font-size:56px;
      line-height:1;
      text-align:right;
      overflow:hidden;
      word-break:break-all;
      user-select:none;
    }
    .keys{flex:1;display:flex;flex-direction:column;gap:10px;padding-bottom:10px}
    .row{display:flex;gap:10px}
    .btn{
      flex:1;height:64px;border-radius:14px;
      background:var(--key);
      border:1px solid var(--line);
      display:flex;align-items:center;justify-content:center;
      font-size:22px;user-select:none;
      transition:transform .05s ease, filter .2s ease;
    }
    .btn:active{transform:translateY(1px);filter:brightness(1.06)}
    .btn.eq{background:var(--key2)}
    .btn.zero{flex:2.15}

    /* overlays */
    .overlay{
      position:fixed;inset:0;
      display:none;
      background:rgba(0,0,0,.62);
      padding:18px 14px;
      align-items:center;justify-content:center;
      z-index:50;
    }
    .overlay.show{display:flex}
    .card{
      width:min(460px,100%);
      border-radius:18px;
      background:rgba(8,18,12,.98);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .cardTop{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .cardTitle{font-size:18px}
    .link{opacity:.75;font-size:14px}
    .input{
      width:100%;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid var(--line);
      background:var(--key);
      color:var(--text);
      font-size:18px;
      outline:none;
      margin-bottom:12px;
    }
    .primary,.secondary{
      width:100%;
      padding:14px;
      border-radius:14px;
      border:1px solid rgba(120,255,170,.14);
      background:var(--key2);
      color:var(--text);
      font-size:16px;
      text-align:center;
      user-select:none;
      margin-top:10px;
    }
    .secondary{background:var(--key);border-color:var(--line)}
    .muted{opacity:.68}
    .small{font-size:12px;opacity:.60;margin-top:10px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .chipRow{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .chip{
      padding:10px 12px;border-radius:999px;
      background:var(--key);
      border:1px solid var(--line);
      user-select:none;
      font-size:14px;
    }
    .quote{
      background:var(--card2);
      border:1px solid rgba(120,255,170,.14);
      border-radius:16px;
      padding:12px 12px;
      margin-top:10px;
    }
    .quote h4{margin:0 0 6px 0;font-size:14px;opacity:.9}
    .quote p{margin:0;line-height:1.4;opacity:.92}
    .streak{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px 12px;
      margin-top:10px;
    }
    .streak h4{margin:0 0 6px 0;font-size:14px;opacity:.9}
    .big{font-size:24px;margin:0 0 4px 0}
    .log{
      margin-top:10px;
      border-top:1px solid rgba(120,255,170,.10);
      padding-top:10px;
      display:flex;flex-direction:column;gap:8px;
      max-height:160px;overflow:auto;
    }
    .logItem{display:flex;justify-content:space-between;gap:10px;font-size:12px;opacity:.85}
    .badge{font-weight:700;opacity:.92}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar"><div class="title">Calculator</div></div>
    <div id="display" class="display">0</div>

    <div class="keys">
      <div class="row">
        <div class="btn" data-k="C">C</div>
        <div class="btn" data-k="÷">÷</div>
        <div class="btn" data-k="×">×</div>
        <div class="btn" data-k="-">-</div>
      </div>
      <div class="row">
        <div class="btn" data-k="7">7</div><div class="btn" data-k="8">8</div><div class="btn" data-k="9">9</div><div class="btn" data-k="+">+</div>
      </div>
      <div class="row">
        <div class="btn" data-k="4">4</div><div class="btn" data-k="5">5</div><div class="btn" data-k="6">6</div><div class="btn eq" data-k="=">=</div>
      </div>
      <div class="row">
        <div class="btn" data-k="1">1</div><div class="btn" data-k="2">2</div><div class="btn" data-k="3">3</div><div class="btn" data-k=".">.</div>
      </div>
      <div class="row">
        <div id="zero" class="btn zero" data-k="0">0</div>
      </div>
    </div>
  </div>

  <!-- PIN overlay -->
  <div id="pinOverlay" class="overlay">
    <div class="card">
      <div class="cardTop">
        <div id="pinTitle" class="cardTitle">Enter PIN</div>
        <div id="pinClose" class="link">Close</div>
      </div>
      <input id="pinInput" class="input" inputmode="numeric" autocomplete="one-time-code" placeholder="••••" maxlength="8" />
      <div id="pinOk" class="primary">OK</div>
      <div class="small muted">Tip: long-press <b>0</b> or tap the display <b>7</b> times.</div>
    </div>
  </div>

  <!-- Hidden overlay -->
  <div id="hiddenOverlay" class="overlay">
    <div class="card" style="max-height:92vh; overflow:auto;">
      <div class="cardTop">
        <div class="cardTitle">Notes</div>
        <div id="hideBtn" class="link">Hide</div>
      </div>

      <div class="quote">
        <h4>Daily quote</h4>
        <p id="dailyQuote">—</p>
        <div class="small muted">New one each day (offline).</div>
      </div>

      <div class="streak">
        <h4>Streak</h4>
        <p id="streakText" class="big">00:00:00</p>
        <div class="small muted">Local only. Nothing leaves your phone.</div>
      </div>

      <div class="grid2">
        <div id="panicBtn" class="primary">Panic / Reset</div>
        <div id="logResetBtn" class="secondary">Log Reset</div>
      </div>

      <div class="grid2">
        <div id="logWinBtn" class="secondary">Log Win</div>
        <div id="rainBtn" class="secondary">Rain: Off</div>
      </div>

      <div class="log" id="logList"></div>

      <div class="small muted">Quick hide returns to calculator instantly.</div>
    </div>
  </div>

  <!-- Panic overlay -->
  <div id="panicOverlay" class="overlay">
    <div class="card">
      <div class="cardTop">
        <div class="cardTitle">Reset</div>
        <div id="panicClose" class="link">Close</div>
      </div>

      <div id="panicBreath">
        <div class="muted">Rain-breath: in for 4, out for 6.</div>
        <div id="breathNum" style="font-size:56px;text-align:center;margin:8px 0;">10</div>
        <div class="muted">Win the next minute.</div>
      </div>

      <div id="panicLabel" style="display:none;">
        <div class="cardTitle" style="font-size:16px;margin-bottom:6px;">Label the urge</div>
        <div class="chipRow" id="labelRow"></div>
      </div>

      <div id="panicAction" style="display:none;">
        <div class="cardTitle" style="font-size:16px;margin-bottom:6px;">Do one micro-action</div>
        <div class="muted">Keep it stupid simple.</div>
        <div id="delayBtn" class="primary">Delay 5 minutes</div>
        <div id="actions"></div>
      </div>

      <div id="panicDone" style="display:none;">
        <div class="cardTitle" style="font-size:16px;margin-bottom:6px;">Good.</div>
        <div class="muted">Not forever. Just today.</div>
        <div id="panicBack" class="primary">Back</div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ---------- utilities ----------
  const $ = (id) => document.getElementById(id);
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));
  const pad2 = (n) => (n < 10 ? "0"+n : ""+n);
  const now = () => Date.now();
  const dateKey = () => {
    const d = new Date();
    return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate());
  };
  const hashStr = (s) => {
    let h = 2166136261;
    for (let i=0;i<s.length;i++){ h ^= s.charCodeAt(i); h = Math.imul(h, 16777619); }
    return (h >>> 0);
  };
  const fmtDur = (ms) => {
    const t = Math.max(0, Math.floor(ms/1000));
    const d = Math.floor(t/86400);
    const h = Math.floor((t%86400)/3600);
    const m = Math.floor((t%3600)/60);
    const s = t%60;
    return d>0 ? `${d}d ${pad2(h)}:${pad2(m)}:${pad2(s)}` : `${pad2(h)}:${pad2(m)}:${pad2(s)}`;
  };

  const QUOTES = [
    "Win the next minute. That’s the whole job.",
    "You don’t need motivation. You need a tiny decision.",
    "Urges are waves. You don’t fight waves — you ride them out.",
    "Small discipline, big freedom.",
    "Delay is a superpower.",
    "Make the easy thing the right thing.",
    "You are not the urge. You’re the one noticing it.",
    "Two minutes of control beats two hours of regret.",
    "Not forever. Just today.",
    "Do the boring thing. It works."
  ];

  // ---------- storage ----------
  const KEY_PIN = "scw_pin_v1";
  const KEY_STATE = "scw_state_v1";

  function loadState() {
    const raw = localStorage.getItem(KEY_STATE);
    if (!raw) {
      const init = { startTs: now(), lastResetTs: 0, logs: [] };
      localStorage.setItem(KEY_STATE, JSON.stringify(init));
      return init;
    }
    try { return JSON.parse(raw); }
    catch {
      const init = { startTs: now(), lastResetTs: 0, logs: [] };
      localStorage.setItem(KEY_STATE, JSON.stringify(init));
      return init;
    }
  }
  function saveState(st){ localStorage.setItem(KEY_STATE, JSON.stringify(st)); }

  function addLog(type, note) {
    const st = loadState();
    st.logs.unshift({ id: now()+"_"+Math.random().toString(16).slice(2), ts: now(), type, note: note || "" });
    st.logs = st.logs.slice(0, 60);
    saveState(st);
    renderHidden();
  }

  function logReset(){
    const st = loadState();
    st.lastResetTs = now();
    st.logs.unshift({ id: now()+"_"+Math.random().toString(16).slice(2), ts: now(), type: "reset", note: "" });
    st.logs = st.logs.slice(0, 60);
    saveState(st);
    renderHidden();
    alert("Logged (local only).");
  }

  // ---------- calculator ----------
  const display = $("display");
  let memA = null;
  let memOp = null;

  function setDisp(v){
    display.textContent = (""+v).slice(0, 20);
  }

  function press(k){
    let cur = display.textContent;

    if (k === "C"){ memA=null; memOp=null; setDisp("0"); return; }

    if (k === "="){
      if (!memOp || memA === null) return;
      const a = memA;
      const b = parseFloat(cur);
      let out = b;
      if (memOp === "+") out = a + b;
      if (memOp === "-") out = a - b;
      if (memOp === "×") out = a * b;
      if (memOp === "÷") out = (b===0 ? NaN : a / b);
      memA=null; memOp=null;
      setDisp(String(out));
      return;
    }

    if (["+","-","×","÷"].includes(k)){
      memA = parseFloat(cur);
      memOp = k;
      setDisp("0");
      return;
    }

    if (k === "."){
      if (cur.includes(".")) return;
      setDisp(cur + ".");
      return;
    }

    // digit
    if (cur === "0") setDisp(k);
    else setDisp(cur + k);
  }

  document.querySelectorAll(".btn").forEach(b => {
    b.addEventListener("click", () => press(b.dataset.k));
  });

  // secret unlock: long-press 0
  let lpTimer = null;
  $("zero").addEventListener("touchstart", () => {
    lpTimer = setTimeout(() => openPin(), 950);
  }, {passive:true});
  $("zero").addEventListener("touchend", () => { if (lpTimer) clearTimeout(lpTimer); }, {passive:true});

  // secret unlock: tap display 7 times quickly
  let tapCount = 0, tapWindow = null;
  display.addEventListener("click", () => {
    tapCount++;
    if (tapWindow) clearTimeout(tapWindow);
    tapWindow = setTimeout(() => tapCount=0, 900);
    if (tapCount >= 7) { tapCount=0; openPin(); }
  });

  // ---------- PIN gate ----------
  const pinOverlay = $("pinOverlay");
  const pinTitle = $("pinTitle");
  const pinInput = $("pinInput");
  let pinMode = "ENTER";
  let tempPin = "";

  function openPin(){
    pinInput.value = "";
    const stored = localStorage.getItem(KEY_PIN);
    if (!stored){
      pinMode = "SET";
      pinTitle.textContent = "Set PIN";
    } else {
      pinMode = "ENTER";
      pinTitle.textContent = "Enter PIN";
    }
    pinOverlay.classList.add("show");
    setTimeout(()=>pinInput.focus(), 50);
  }

  function closePin(){ pinOverlay.classList.remove("show"); pinInput.value=""; tempPin=""; }

  $("pinClose").addEventListener("click", closePin);

  $("pinOk").addEventListener("click", () => {
    const stored = localStorage.getItem(KEY_PIN);
    const v = (pinInput.value || "").replace(/\D/g,"");
    if (pinMode === "ENTER"){
      if (v && stored && v === stored){
        closePin();
        openHidden();
      } else {
        pinInput.value="";
        alert("Wrong PIN.");
      }
      return;
    }
    if (pinMode === "SET"){
      if (v.length < 4){ alert("Use at least 4 digits."); return; }
      tempPin = v;
      pinMode = "CONFIRM";
      pinTitle.textContent = "Confirm PIN";
      pinInput.value="";
      return;
    }
    if (pinMode === "CONFIRM"){
      if (v !== tempPin){
        alert("Mismatch. Try again.");
        pinMode="SET";
        pinTitle.textContent="Set PIN";
        pinInput.value="";
        tempPin="";
        return;
      }
      localStorage.setItem(KEY_PIN, v);
      alert("PIN set.");
      closePin();
      openHidden();
    }
  });

  // ---------- hidden area ----------
  const hiddenOverlay = $("hiddenOverlay");

  function openHidden(){
    renderHidden();
    hiddenOverlay.classList.add("show");
  }
  function closeHidden(){
    hiddenOverlay.classList.remove("show");
    closePanic();
  }
  $("hideBtn").addEventListener("click", closeHidden);

  function renderHidden(){
    // daily quote
    const idx = hashStr(dateKey()) % QUOTES.length;
    $("dailyQuote").textContent = "“" + QUOTES[idx] + "”";

    // streak
    const st = loadState();
    const anchor = st.lastResetTs > 0 ? st.lastResetTs : st.startTs;
    $("streakText").textContent = fmtDur(now() - anchor);

    // logs
    const list = $("logList");
    list.innerHTML = "";
    (st.logs || []).slice(0, 12).forEach(it => {
      const d = new Date(it.ts);
      const row = document.createElement("div");
      row.className = "logItem";
      row.innerHTML = `<span class="badge">${(it.type||"").toUpperCase()}</span><span>${d.toLocaleString()}</span>`;
      list.appendChild(row);
    });
    if ((st.logs||[]).length === 0){
      const row = document.createElement("div");
      row.className = "logItem";
      row.textContent = "No entries yet.";
      list.appendChild(row);
    }
  }

  // keep streak ticking
  setInterval(() => {
    if (hiddenOverlay.classList.contains("show")) renderHidden();
  }, 1000);

  $("logResetBtn").addEventListener("click", logReset);
  $("logWinBtn").addEventListener("click", () => addLog("win", "chose to stop"));

  // ---------- panic flow ----------
  const panicOverlay = $("panicOverlay");
  const breathNum = $("breathNum");
  const panicBreath = $("panicBreath");
  const panicLabel = $("panicLabel");
  const panicAction = $("panicAction");
  const panicDone = $("panicDone");

  const labels = ["Bored","Stressed","Lonely","Angry","Tired","Procrastinating"];
  const actions = ["Stand up + drink water","20 slow breaths (count them)","Walk to a different room","2 minutes pushups/squats","Put phone down for 60s"];

  labels.forEach(l => {
    const c = document.createElement("div");
    c.className = "chip";
    c.textContent = l;
    c.addEventListener("click", () => { addLog("urge", l); showAction(); });
    $("labelRow").appendChild(c);
  });

  const actionsWrap = $("actions");
  actions.forEach(a => {
    const b = document.createElement("div");
    b.className = "secondary";
    b.textContent = a;
    b.addEventListener("click", () => { addLog("win", a); showDone(); });
    actionsWrap.appendChild(b);
  });

  function openPanic(){
    addLog("urge", "");
    panicOverlay.classList.add("show");
    showBreath();
  }
  function closePanic(){ panicOverlay.classList.remove("show"); }

  function showBreath(){
    panicBreath.style.display = "";
    panicLabel.style.display = "none";
    panicAction.style.display = "none";
    panicDone.style.display = "none";
    let t = 10;
    breathNum.textContent = t;
    const iv = setInterval(() => {
      t--;
      breathNum.textContent = t;
      if (t <= 0){
        clearInterval(iv);
        showLabel();
      }
      if (!panicOverlay.classList.contains("show")) clearInterval(iv);
    }, 1000);
  }
  function showLabel(){
    panicBreath.style.display = "none";
    panicLabel.style.display = "";
    panicAction.style.display = "none";
    panicDone.style.display = "none";
  }
  function showAction(){
    panicBreath.style.display = "none";
    panicLabel.style.display = "none";
    panicAction.style.display = "";
    panicDone.style.display = "none";
  }
  function showDone(){
    panicBreath.style.display = "none";
    panicLabel.style.display = "none";
    panicAction.style.display = "none";
    panicDone.style.display = "";
  }

  $("panicBtn").addEventListener("click", openPanic);
  $("panicClose").addEventListener("click", closePanic);
  $("panicBack").addEventListener("click", closePanic);
  $("delayBtn").addEventListener("click", async () => {
    // basic delay signal (no system notification on iOS web reliably)
    addLog("win","delay 5m");
    alert("Delay started: 5 minutes. Put the phone down for 30 seconds.");
    showDone();
  });

  // ---------- rain ambience (WebAudio; no file assets) ----------
  let audioCtx = null;
  let rainNode = null;
  let rainOn = false;

  function startRain(){
    if (rainOn) return;
    audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
    const ctx = audioCtx;

    // pink-ish noise via filtered white + gentle drops
    const bufferSize = 2 * ctx.sampleRate;
    const noiseBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
    const output = noiseBuffer.getChannelData(0);
    for (let i = 0; i < bufferSize; i++) output[i] = Math.random() * 2 - 1;

    const noise = ctx.createBufferSource();
    noise.buffer = noiseBuffer;
    noise.loop = true;

    const filter = ctx.createBiquadFilter();
    filter.type = "lowpass";
    filter.frequency.value = 1200;

    const gain = ctx.createGain();
    gain.gain.value = 0.12;

    // droplets: random click bursts
    const dropGain = ctx.createGain();
    dropGain.gain.value = 0.0;

    const outGain = ctx.createGain();
    outGain.gain.value = 0.9;

    noise.connect(filter);
    filter.connect(gain);
    gain.connect(outGain);
    outGain.connect(ctx.destination);

    // schedule droplets
    let dropletTimer = null;
    const makeDrop = () => {
      if (!rainOn) return;
      const o = ctx.createOscillator();
      o.type = "triangle";
      o.frequency.value = 900 + Math.random()*900;
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.0001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.06 + Math.random()*0.06, ctx.currentTime + 0.005);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.08 + Math.random()*0.08);
      o.connect(g);
      g.connect(ctx.destination);
      o.start();
      o.stop(ctx.currentTime + 0.18);
      dropletTimer = setTimeout(makeDrop, 120 + Math.random()*260);
    };

    noise.start();
    rainNode = { noise, dropletTimer, makeDrop };
    rainOn = true;
    $("rainBtn").textContent = "Rain: On";
    makeDrop();
  }

  function stopRain(){
    if (!rainOn) return;
    rainOn = false;
    $("rainBtn").textContent = "Rain: Off";
    try{
      if (rainNode?.dropletTimer) clearTimeout(rainNode.dropletTimer);
      rainNode?.noise?.stop();
    }catch(_){}
    rainNode = null;
  }

  $("rainBtn").addEventListener("click", async () => {
    // iOS requires user interaction; this click counts
    if (!rainOn){
      try{
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === "suspended") await audioCtx.resume();
      }catch(_){}
      startRain();
    } else {
      stopRain();
    }
  });

  // service worker (optional)
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js").catch(()=>{});
  }
})();
</script>
</body>
</html>
